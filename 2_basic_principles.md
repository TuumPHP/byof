フレームワーク設計方針
==================

#### デザイン要件：フロント側のフーレムワーク設計

今回のフレームワークでは、httpリクエストを受け取ってからコントローラを呼び出すところ、それとビュー（Htmlなど）を返す部分について考えます。つまりORMなど、MVCでいうモデルは考えません。

#### デザイン要件：HTTPスタックを基本にする

基本になるのはStackPHPの考え方です。

入力としてHTTPリクエストを取り、出力にHTTPリスポンスを返すまでをフレームワーク＝アプリケーションとして考えます。


アプリケーションの概念設計
----------------

### HTTPの基本

想定している、ウェブアプリケーションの使い方です。
SymfonyのHttp-Foundationを基本に考えます。

```php
/*
 * まずはアプリケーションを構築する。
 */
$app = function_to_build_framework();

/*
 * アプリケーションを走らせる。
 */
$request  = Request::create($_SERVER); // 入力はHTTPリクエスト。
$response = $app->run($request); // 実行！
/*
 * $responseが実行結果
 */
$response->render(); // httpリスポンスを返す
```

ここで、
*   $appがアプリケーション、
*   $requestはHTTPリクエスト、
*   $responseがHTTPリスポンス、

です。

$appを最初に構築。構築の仕方は、これから考えるので、ひとまず「function_to_build_framework」という関数で作ることとしてあります。

$appの入力が、HTTPリクエスト。要はSymfonyのRequestオブジェクトですね。HTTPリクエストの情報以外に、PHP独特の設定やセッションなども含むと考えます。

#### デザイン要件：アプリケーションとリクエストの分離

今回の設計において、$requestと$responseがリクエストごとに異なる値を持ちますが、$appは常に同じ状態を保つことを目指したいと思います。

できれば、処理実行前と後で$appの状態が同じであるのが理想です。

これにより、アプリケーションオブジェクト（$app）とリクエスト＆リスポンスがキレイに分離されることになるのではないでしょうか。


HTTPスタックとミドルウェア
----------------------

HTTPスタックとは、先に述べた、入力としてHTTPリクエストを受け取り、HTTPリスポンスを返すオブジェクトのことです。

これをミドルウェアという形でチェーンとしてつなげて次々と実行することで、ウェブアプリケーションを構築します。

例えば、RubyのRackを参考にすれば、次のようなHTTPスタックのチェーンを作成します。

```php
class HttpStack {
  protected $next;
  function call($request) {
    // do some job.
    $response = $this->next->call($request);
    // do more job.
    return $response;
  }
}
```

ここでは、$nextが次のミドルウェアで、次々と実行することができます。どこかのミドルウェアでリスポンスが帰ってきたら、チェーンは終わりです。今度は次々とリスポンスを返してゆきます。

> これはChain of Responsibility パターンになると思います。
> 一方、各HTTPスタックで$requestの内容を変更してゆくこともおおいので、decoratorパターンでもあります。

#### デザイン要件：できるだけHTTPスタックで機能を実現する

できるだけHTTPスタックでアプリケーションを構築する、ということです。

全てをスタックで表現できないと思いますが、少なくともURLのルーティングぐらいは十分可能です。

一方でスタックに合わない要素は出てくるはず。その場合は、
*   リクエストごとに異なる場合は$requestまたは$responseで、
*   それ以外は$appで、

実装します。

この「それ以外」とは、何があるのでしょうね。

思いつくのは、
*   設定、
*   イベンt・フック、
*   サービス、フィルター、もろもろのコンテナ、
*   テンプレート・ビュー、

あたりでしょうか。このへんも、後で設計したいと思います。


### その他、必要な機能

次のような機能が必要になると思いますが、おいおい考えてゆくことで。

コンフィグ
フィルター
サービス
DIコンテナ
テンプレートエンジン



