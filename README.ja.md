Build Your Own Framework (BYOF) using PHP
=========================================

TuumPHPの設計覚書。

目標としたこと
----------------------

例えば10年といった長期間サポートできるためのフレームワークを作成することが目標です。このため、下記の方針で開発します。

*   いざとなれば自分で修正できるシンプルな設計とコード。
*   黒魔術は使わないこと。でも開発しやすい。
*   コンポーネントベースかつ依存性を低くすること。

また、

*   フロント側のフレームワーク

とします。バックエンド・インフラとなるデータベース関連は別途考えます。


### 良いフレームワークとは

作って動かすだけなら何とか出来ますが、必ずしも良いフレームワークになりません。長くサポートするには、作りが良くなければなりません。まぁ設計が大事です。では「良いフレームワーク」というのは何か？を考えてみます。

まず「設計に一貫性があること」。

設計方針が同じであれば、内容を理解して修正しやすいフレームワークになると考えます。この場合はこっち、あの場合はそっち、だと疲れますよね。

「合理的であること」

できるだけ、今までの知見を反映した設計を使ってゆくこと。


### 「なぜ？」が大事

結局「何故こういう設計にしたのか」を考えることで、分かりやすくて正しい設計になるはず。だから、こんな文章を書いてます。

> 有名なフレームワークを見れば、使い方などのマニュアルは充実してますし、コードを読めば解決した方法は分かります。ただ、今の設計になったのはなぜか、ということが書かれていることは少ないと思います。


ウェブアプリケーションとは何か？
----

まず最初は、ウェブアプリケーションとは何か？からです。色々な答えがありますが、Symfonyなどでも使われている一番簡単な答えを元にします。

```php
$response = $app($request);
```

ここで、

*   ```$app```がウェブアプリケーション、
*   ```$request```がHTTPリクエスト、
*   ```$response```を返します。

これだけ！
この３つについて、考えてゆきます。

### [X] 不変オブジェクト

バグの減らすため、できるだけ状態を持たないことを目標とします。

まずは、アプリケーションを出来るだけ不変とします。実行の前と後で状態が変わらないのが目標です。

すると、処理結果などは```$request```か```$response```が持つことになります。

### [X] Middlewareをベースに

[StackPHP](http://stackphp.com/) で有名になりましたが、ミドルウェアをベースにアプリケーションを構築します。できるだけミドルウェアを使って実装します。

### [X] PSR-7 Http Message

Psr-7が出てきましたので、これを使います。Psr−7では、これらのオブジェクトも不変オブジェクトとなりますが、オブジェクトを「乗り継ぎ」ながら、次々と処理を行うことになります。


ミドルウェアとスタック設計
-----------

### [X] CoRチェーン

ミドルウェアを実装するに当たり、Chain of Responsibilityパターンを採用します。APIには、先のウェブアプリケーションを用いることにします。

```php
$response = $app($request);
```

> これを採用した理由ですが、
>
> *   APIとして最も簡単。フィルターを作成する際も最低限の依存で開発可能。
*   Strutsのような```$app($request, $response);```のAPIも考えたが、Psr-7に```Response::withAttribute```が無く、データを持ち回すのに使いづらかった。
*   Conduitのような```$app($request, $response, $next);```は単純に$nextが面倒そうで…
>
> と決定的な理由は考えられなかったです。単に慣れてただけという話も。また、メソッドを使ってもいいのですが、メソッド名を感がなくていいクロージャーとして設計を進めます。

チェーンの構築は、pushメソッドを使って追加することにします。

```php
$app
    ->push($middleware1)
    ->push($middleware2);
$response = $app($request);
```

CoRらしく、```$response```が帰ってきた時点でチェーンの実行をストップし、チェーンを巻き戻してゆきます。

### [X] Middlewareと実処理の分離

実際に処理を行うオブジェクト（```$app```）と、ミドルウェアとしてチェーンの構築・実行を行うオブジェクト(```$middleware```)を分離します。

```php
$middleware = new Middleware($app);
```


### リクエスト

Psr-7を設計している人のリクエストを元に作成します。

さて、セッションのようにリクエストごとに異なるデータや、処理していて変更・追加される情報は全部```$request```が持つことになります。


### リクエストへのリスポンス

使いやすいリクエストについて考えます。

例えば、リダイレクトを行う場合、前のURLに戻る、あるいはパスだけ（ホスト名などを省略する）などがありえます。多少ですが、レスポンスはリクエストに依存すると考えます。

情報の流れとオブジェクトの関係を対応させたいので、下記のような方法でレスポンスを生成することにします。

```php
$request->responseFactory()->responseType();
```


### Loggerもリクエストに





